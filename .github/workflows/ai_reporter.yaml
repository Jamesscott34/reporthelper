name: ğŸ¤– AI Report Writer CI/CD Pipeline

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      run_security_scan:
        description: 'Run security scan'
        required: false
        default: true
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # ============================================================================
  # ğŸ” PRE-FLIGHT CHECKS
  # ============================================================================
  pre-flight:
    name: ğŸ” Pre-flight Checks
    runs-on: ubuntu-latest
    outputs:
      python-version: ${{ steps.setup.outputs.python-version }}
      should-deploy: ${{ steps.deployment-check.outputs.should-deploy }}
      environment: ${{ steps.deployment-check.outputs.environment }}

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ”§ Setup Environment Info
      id: setup
      run: |
        echo "python-version=${{ env.PYTHON_VERSION }}" >> $GITHUB_OUTPUT
        echo "ğŸ Python Version: ${{ env.PYTHON_VERSION }}"
        echo "ğŸ“¦ Node Version: ${{ env.NODE_VERSION }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "ğŸ¯ Event: ${{ github.event_name }}"

    - name: ğŸš€ Deployment Check
      id: deployment-check
      run: |
        if [[ "${{ github.ref_name }}" == "main" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "should-deploy=true" >> $GITHUB_OUTPUT
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            echo "environment=production" >> $GITHUB_OUTPUT
          fi
        else
          echo "should-deploy=false" >> $GITHUB_OUTPUT
          echo "environment=none" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ“‹ Workflow Summary
      run: |
        echo "## ğŸ¤– AI Report Writer Pipeline Started" >> $GITHUB_STEP_SUMMARY
        echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ Python | ${{ env.PYTHON_VERSION }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸŒ¿ Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ¯ Event | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸš€ Deploy | ${{ steps.deployment-check.outputs.should-deploy }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸŒ Environment | ${{ steps.deployment-check.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ğŸ PYTHON ENVIRONMENT SETUP & VALIDATION
  # ============================================================================
  setup-python:
    name: ğŸ Python Environment Setup
    runs-on: ubuntu-latest
    needs: pre-flight
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python ${{ needs.pre-flight.outputs.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ needs.pre-flight.outputs.python-version }}

    - name: ğŸ”‘ Generate Cache Key
      id: cache-key
      run: |
        echo "key=python-${{ runner.os }}-${{ hashFiles('requirements.txt') }}" >> $GITHUB_OUTPUT

    - name: ğŸ“¦ Cache Python Dependencies
      uses: actions/cache@v3
      id: cache
      with:
        path: ~/.cache/pip
        key: ${{ steps.cache-key.outputs.key }}
        restore-keys: |
          python-${{ runner.os }}-

    - name: â¬†ï¸ Upgrade pip and setuptools
      run: |
        python -m pip install --upgrade pip setuptools wheel
        echo "âœ… pip upgraded to $(pip --version)"

    - name: ğŸ“¦ Install Dependencies
      run: |
        echo "ğŸ“¥ Installing core dependencies..."
        pip install -r requirements.txt
        echo "âœ… Dependencies installed successfully"

    - name: ğŸ” Verify Installation
      run: |
        echo "ğŸ” Verifying Python environment..."
        python --version
        pip list

        echo "ğŸ§ª Testing core imports..."
        python -c "import django; print(f'âœ… Django {django.get_version()}')"
        python -c "import rest_framework; print('âœ… Django REST Framework')"
        python -c "import channels; print('âœ… Django Channels')"
        python -c "import requests; print('âœ… Requests')"

    - name: ğŸ“Š Environment Summary
      run: |
        echo "## ğŸ Python Environment Ready" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Python | âœ… $(python --version) |" >> $GITHUB_STEP_SUMMARY
        echo "| pip | âœ… $(pip --version) |" >> $GITHUB_STEP_SUMMARY
        echo "| Django | âœ… $(python -c 'import django; print(django.get_version())') |" >> $GITHUB_STEP_SUMMARY
        echo "| Dependencies | âœ… $(pip list | wc -l) packages |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ğŸ—„ï¸ DATABASE SETUP & MIGRATIONS
  # ============================================================================
  database-setup:
    name: ğŸ—„ï¸ Database Setup & Migrations
    runs-on: ubuntu-latest
    needs: [pre-flight, setup-python]

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python ${{ needs.pre-flight.outputs.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ needs.pre-flight.outputs.python-version }}

    - name: ğŸ“¦ Restore Python Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ needs.setup-python.outputs.cache-key }}
        restore-keys: |
          python-${{ runner.os }}-

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: âš™ï¸ Setup Environment Variables
      env:
        SECRET_KEY: ${{ secrets.SECRET_KEY || 'django-test-secret-key-for-ci-cd-pipeline-only' }}
        DEBUG: ${{ secrets.DEBUG || 'True' }}
        ALLOWED_HOSTS: ${{ secrets.ALLOWED_HOSTS || 'localhost,127.0.0.1,testserver' }}
        OPENROUTER_HOST: ${{ secrets.OPENROUTER_HOST || 'https://openrouter.ai/api/v1' }}
        OPENROUTER_API_KEY_OPENROUTER: ${{ secrets.OPENROUTER_API_KEY_OPENROUTER || 'test-key-openrouter' }}
        BREAKDOWN_MODEL: ${{ secrets.BREAKDOWN_MODEL || 'deepseek/deepseek-r1-0528-qwen3-8b:free' }}
        REVIEWER_MODEL: ${{ secrets.REVIEWER_MODEL || 'tngtech/deepseek-r1t2-chimera:free' }}
        FINALIZER_MODEL: ${{ secrets.FINALIZER_MODEL || 'deepseek/deepseek-r1-0528-qwen3-8b:free' }}
        REANALYZER_MODEL: ${{ secrets.REANALYZER_MODEL || 'openrouter/horizon-beta' }}
        DATABASE_URL: ${{ secrets.DATABASE_URL || 'sqlite:///test_db.sqlite3' }}
        LOG_LEVEL: ${{ secrets.LOG_LEVEL || 'INFO' }}
        LOG_FILE: ${{ secrets.LOG_FILE || 'logs/test.log' }}
      run: |
        echo "ğŸ”§ Creating environment configuration from GitHub secrets..."
        cat > .env << EOF
        DEBUG=${DEBUG}
        SECRET_KEY=${SECRET_KEY}
        ALLOWED_HOSTS=${ALLOWED_HOSTS}

        # AI Configuration
        OPENROUTER_HOST=${OPENROUTER_HOST}
        OPENROUTER_API_KEY_OPENROUTER=${OPENROUTER_API_KEY_OPENROUTER}
        BREAKDOWN_MODEL=${BREAKDOWN_MODEL}
        REVIEWER_MODEL=${REVIEWER_MODEL}
        FINALIZER_MODEL=${FINALIZER_MODEL}
        REANALYZER_MODEL=${REANALYZER_MODEL}

        # Database Configuration
        DATABASE_URL=${DATABASE_URL}

        # Logging Configuration
        LOG_LEVEL=${LOG_LEVEL}
        LOG_FILE=${LOG_FILE}
        EOF
        echo "âœ… Environment configuration created from GitHub secrets"

    - name: ğŸ“ Create Required Directories
      run: |
        echo "ğŸ“ Creating project directories..."
        mkdir -p logs
        mkdir -p media/documents
        mkdir -p staticfiles
        mkdir -p test_results
        echo "âœ… Directories created"

    - name: ğŸ” Django System Check
      run: |
        echo "ğŸ” Running Django system checks..."
        python manage.py check --deploy
        echo "âœ… Django system check passed"

    - name: ğŸ—„ï¸ Create Migrations
      run: |
        echo "ğŸ—„ï¸ Creating database migrations..."
        python manage.py makemigrations --dry-run --verbosity=2
        python manage.py makemigrations --verbosity=2
        echo "âœ… Migrations created successfully"

    - name: ğŸ—„ï¸ Apply Migrations
      run: |
        echo "ğŸ—„ï¸ Applying database migrations..."
        python manage.py migrate --verbosity=2
        python manage.py showmigrations
        echo "âœ… Migrations applied successfully"

    - name: ğŸ” Database Validation
      run: |
        echo "ğŸ” Validating database setup..."
        python manage.py shell -c "
        from django.db import connection
        from django.contrib.auth.models import User
        from breakdown.models import Document, Breakdown, Section, Annotation

        # Test database connection
        connection.ensure_connection()
        print('âœ… Database connection successful')

        # Test model creation
        user_count = User.objects.count()
        print(f'âœ… User model accessible: {user_count} users')

        doc_count = Document.objects.count()
        print(f'âœ… Document model accessible: {doc_count} documents')

        breakdown_count = Breakdown.objects.count()
        print(f'âœ… Breakdown model accessible: {breakdown_count} breakdowns')

        section_count = Section.objects.count()
        print(f'âœ… Section model accessible: {section_count} sections')

        annotation_count = Annotation.objects.count()
        print(f'âœ… Annotation model accessible: {annotation_count} annotations')

        print('ğŸ‰ All models are working correctly!')
        "

    - name: ğŸ“Š Database Summary
      run: |
        echo "## ğŸ—„ï¸ Database Setup Complete" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| System Check | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
        echo "| Migrations | âœ… Applied |" >> $GITHUB_STEP_SUMMARY
        echo "| Models | âœ… Validated |" >> $GITHUB_STEP_SUMMARY
        echo "| Connection | âœ… Working |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ğŸ§ª COMPREHENSIVE TEST SUITE
  # ============================================================================
  test-suite:
    name: ğŸ§ª Comprehensive Test Suite
    runs-on: ubuntu-latest
    needs: [pre-flight, setup-python, database-setup]

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python ${{ needs.pre-flight.outputs.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ needs.pre-flight.outputs.python-version }}

    - name: ğŸ“¦ Restore Python Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ needs.setup-python.outputs.cache-key }}
        restore-keys: |
          python-${{ runner.os }}-

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: âš™ï¸ Setup Test Environment
      env:
        SECRET_KEY: ${{ secrets.SECRET_KEY || 'django-test-secret-key-for-ci-cd-pipeline-only' }}
        DEBUG: 'True'
        ALLOWED_HOSTS: ${{ secrets.ALLOWED_HOSTS || 'localhost,127.0.0.1,testserver' }}
        OPENROUTER_HOST: ${{ secrets.OPENROUTER_HOST || 'https://openrouter.ai/api/v1' }}
        OPENROUTER_API_KEY_OPENROUTER: ${{ secrets.OPENROUTER_API_KEY_OPENROUTER || 'test-key-openrouter' }}
        BREAKDOWN_MODEL: ${{ secrets.BREAKDOWN_MODEL || 'deepseek/deepseek-r1-0528-qwen3-8b:free' }}
        REVIEWER_MODEL: ${{ secrets.REVIEWER_MODEL || 'tngtech/deepseek-r1t2-chimera:free' }}
        FINALIZER_MODEL: ${{ secrets.FINALIZER_MODEL || 'deepseek/deepseek-r1-0528-qwen3-8b:free' }}
        REANALYZER_MODEL: ${{ secrets.REANALYZER_MODEL || 'openrouter/horizon-beta' }}
        DATABASE_URL: 'sqlite:///test_db.sqlite3'
        LOG_LEVEL: 'DEBUG'
        LOG_FILE: 'logs/test.log'
      run: |
        echo "ğŸ”§ Setting up test environment from GitHub secrets..."
        cat > .env << EOF
        DEBUG=${DEBUG}
        SECRET_KEY=${SECRET_KEY}
        ALLOWED_HOSTS=${ALLOWED_HOSTS}

        # AI Configuration
        OPENROUTER_HOST=${OPENROUTER_HOST}
        OPENROUTER_API_KEY_OPENROUTER=${OPENROUTER_API_KEY_OPENROUTER}
        BREAKDOWN_MODEL=${BREAKDOWN_MODEL}
        REVIEWER_MODEL=${REVIEWER_MODEL}
        FINALIZER_MODEL=${FINALIZER_MODEL}
        REANALYZER_MODEL=${REANALYZER_MODEL}

        # Database Configuration
        DATABASE_URL=${DATABASE_URL}

        # Testing Configuration
        TESTING=True
        DISABLE_API_CALLS=True

        # Logging Configuration
        LOG_LEVEL=${LOG_LEVEL}
        LOG_FILE=${LOG_FILE}
        EOF

        # Create directories
        mkdir -p logs media/documents staticfiles test_results

        # Apply migrations
        python manage.py migrate --verbosity=0

    - name: ğŸ§ª Run Custom Test Suite
      run: |
        echo "ğŸ§ª Running comprehensive test suite..."
        python run_tests.py
        echo "âœ… Custom test suite completed"

    - name: ğŸ§ª Run Django Tests
      run: |
        echo "ğŸ§ª Running Django test suite..."
        python manage.py test --verbosity=2 --keepdb
        echo "âœ… Django tests completed"

    - name: ğŸ“Š Test Coverage Analysis
      run: |
        echo "ğŸ“Š Analyzing test coverage..."
        pip install coverage
        coverage run --source='.' manage.py test
        coverage report --show-missing
        coverage html
        echo "âœ… Coverage analysis completed"

    - name: ğŸ“¤ Upload Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results
        path: |
          test_results/
          htmlcov/
          logs/
        retention-days: 30

    - name: ğŸ“Š Test Summary
      if: always()
      run: |
        echo "## ğŸ§ª Test Suite Results" >> $GITHUB_STEP_SUMMARY

        # Parse test results if available
        if [ -d "test_results" ]; then
          latest_run=$(ls -t test_results/ | head -n1)
          if [ -f "test_results/$latest_run/summary.json" ]; then
            python3 << 'EOF'
        import json
        import os
try:
    with open(f'test_results/{os.listdir("test_results")[0]}/summary.json', 'r') as f:
        results = json.load(f)
    print(f"| Total Tests | {results.get('total_tests', 'N/A')} |")
    print(f"| Passed | {results.get('passed_tests', 'N/A')} |")
    print(f"| Failed | {results.get('failed_tests', 'N/A')} |")
    print(f"| Skipped | {results.get('skipped_tests', 'N/A')} |")
    print(f"| Duration | {results.get('duration', 'N/A')}s |")
except:
    print("| Status | âœ… Tests Completed |")
EOF
          fi
        fi

  # ============================================================================
  # ğŸ¨ CODE QUALITY & FORMATTING
  # ============================================================================
  code-quality:
    name: ğŸ¨ Code Quality & Formatting
    runs-on: ubuntu-latest
    needs: [pre-flight, setup-python]

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python ${{ needs.pre-flight.outputs.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ needs.pre-flight.outputs.python-version }}

    - name: ğŸ“¦ Restore Python Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ needs.setup-python.outputs.cache-key }}
        restore-keys: |
          python-${{ runner.os }}-

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ” Import Sorting (isort)
      run: |
        echo "ğŸ” Checking import sorting..."
        python -m isort --check-only --diff .
        echo "âœ… Import sorting check passed"

    - name: ğŸ¨ Code Formatting (black)
      run: |
        echo "ğŸ¨ Checking code formatting..."
        python -m black --check --diff .
        echo "âœ… Code formatting check passed"

    - name: ğŸ” Linting (flake8)
      run: |
        echo "ğŸ” Running code linting..."
        python -m flake8 --statistics --tee --output-file=flake8-report.txt
        echo "âœ… Linting check passed"

    - name: ğŸ·ï¸ Type Checking (mypy)
      run: |
        echo "ğŸ·ï¸ Running type checking..."
        python -m mypy breakdown ai_report_writer --ignore-missing-imports --show-error-codes | tee mypy-report.txt
        echo "âœ… Type checking completed"

    - name: ğŸ“¤ Upload Quality Reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: code-quality-reports
        path: |
          flake8-report.txt
          mypy-report.txt
        retention-days: 30

    - name: ğŸ“Š Quality Summary
      run: |
        echo "## ğŸ¨ Code Quality Results" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Import Sorting | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
        echo "| Code Formatting | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
        echo "| Linting | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
        echo "| Type Checking | âœ… Completed |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ğŸ”’ SECURITY SCANNING
  # ============================================================================
  security-scan:
    name: ğŸ”’ Security Scanning
    runs-on: ubuntu-latest
    needs: [pre-flight, setup-python]
    if: github.event_name == 'push' || github.event.inputs.run_security_scan == 'true'

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python ${{ needs.pre-flight.outputs.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ needs.pre-flight.outputs.python-version }}

    - name: ğŸ“¦ Restore Python Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ needs.setup-python.outputs.cache-key }}
        restore-keys: |
          python-${{ runner.os }}-

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ”’ Security Linting (bandit)
      run: |
        echo "ğŸ”’ Running security analysis..."
        python -m bandit -r breakdown ai_report_writer -f json -o bandit-report.json || true
        python -m bandit -r breakdown ai_report_writer -f screen -ll
        echo "âœ… Security analysis completed"

    - name: ğŸ›¡ï¸ Dependency Vulnerability Scan (safety)
      run: |
        echo "ğŸ›¡ï¸ Scanning dependencies for vulnerabilities..."
        python -m safety check -r requirements.txt --full-report --output json --output-file safety-report.json || true
        python -m safety check -r requirements.txt --full-report
        echo "âœ… Dependency scan completed"

    - name: ğŸ” Secret Detection
      run: |
        echo "ğŸ” Scanning for secrets..."
        python -m detect_secrets scan --all-files --baseline .secrets.baseline
        echo "âœ… Secret detection completed"

    - name: ğŸ“¤ Upload Security Reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
        retention-days: 30

    - name: ğŸ“Š Security Summary
      run: |
        echo "## ğŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "| Scan Type | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Code Security | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
        echo "| Dependencies | âœ… Scanned |" >> $GITHUB_STEP_SUMMARY
        echo "| Secret Detection | âœ… Completed |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ğŸ“¦ BUILD & PACKAGE
  # ============================================================================
  build-package:
    name: ğŸ“¦ Build & Package
    runs-on: ubuntu-latest
    needs: [pre-flight, setup-python, database-setup, test-suite, code-quality]
    if: needs.pre-flight.outputs.should-deploy == 'true'

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python ${{ needs.pre-flight.outputs.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ needs.pre-flight.outputs.python-version }}

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: âš™ï¸ Setup Production Environment
      env:
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
        ALLOWED_HOSTS: ${{ secrets.ALLOWED_HOSTS }}
        OPENROUTER_HOST: ${{ secrets.OPENROUTER_HOST || 'https://openrouter.ai/api/v1' }}
        OPENROUTER_API_KEY_DEEPSEEK: ${{ secrets.OPENROUTER_API_KEY_DEEPSEEK }}
        OPENROUTER_API_KEY_TNGTECH: ${{ secrets.OPENROUTER_API_KEY_TNGTECH }}
        OPENROUTER_API_KEY_OPENROUTER: ${{ secrets.OPENROUTER_API_KEY_OPENROUTER }}
        BREAKDOWN_MODEL: ${{ secrets.BREAKDOWN_MODEL || 'deepseek/deepseek-r1-0528-qwen3-8b:free' }}
        REVIEWER_MODEL: ${{ secrets.REVIEWER_MODEL || 'tngtech/deepseek-r1t2-chimera:free' }}
        FINALIZER_MODEL: ${{ secrets.FINALIZER_MODEL || 'deepseek/deepseek-r1-0528-qwen3-8b:free' }}
        REANALYZER_MODEL: ${{ secrets.REANALYZER_MODEL || 'openrouter/horizon-beta' }}
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        LOG_LEVEL: ${{ secrets.LOG_LEVEL || 'INFO' }}
        LOG_FILE: ${{ secrets.LOG_FILE || 'logs/app.log' }}
      run: |
        echo "âš™ï¸ Creating production environment configuration from GitHub secrets..."
        cat > .env.production << EOF
        DEBUG=False
        SECRET_KEY=${SECRET_KEY}
        ALLOWED_HOSTS=${ALLOWED_HOSTS}

        # AI Configuration
        OPENROUTER_HOST=${OPENROUTER_HOST}
        OPENROUTER_API_KEY_OPENROUTER=${OPENROUTER_API_KEY_OPENROUTER}
        BREAKDOWN_MODEL=${BREAKDOWN_MODEL}
        REVIEWER_MODEL=${REVIEWER_MODEL}
        FINALIZER_MODEL=${FINALIZER_MODEL}
        REANALYZER_MODEL=${REANALYZER_MODEL}

        # Database Configuration
        DATABASE_URL=${DATABASE_URL}

        # Logging Configuration
        LOG_LEVEL=${LOG_LEVEL}
        LOG_FILE=${LOG_FILE}
        EOF
        echo "âœ… Production environment configuration created from GitHub secrets"

    - name: ğŸ“ Collect Static Files
      run: |
        echo "ğŸ“ Collecting static files..."
        mkdir -p staticfiles
        python manage.py collectstatic --noinput --verbosity=2
        echo "âœ… Static files collected"

    - name: ğŸ“¦ Create Distribution Package
      run: |
        echo "ğŸ“¦ Creating distribution package..."

        # Create deployment directory
        mkdir -p dist/ai-report-writer

        # Copy application files
        cp -r breakdown/ dist/ai-report-writer/
        cp -r ai_report_writer/ dist/ai-report-writer/
        cp -r templates/ dist/ai-report-writer/
        cp -r static/ dist/ai-report-writer/
        cp -r staticfiles/ dist/ai-report-writer/
        cp -r scripts/ dist/ai-report-writer/
        cp -r docs/ dist/ai-report-writer/

        # Copy configuration files
        cp requirements.txt dist/ai-report-writer/
        cp manage.py dist/ai-report-writer/
        cp .env.production dist/ai-report-writer/.env.example
        cp README.md dist/ai-report-writer/
        cp pyproject.toml dist/ai-report-writer/
        cp .flake8 dist/ai-report-writer/
        cp Makefile dist/ai-report-writer/

        # Create deployment scripts
        cat > dist/ai-report-writer/deploy.sh << 'EOF'
#!/bin/bash
echo "ğŸš€ AI Report Writer Deployment Script"
echo "===================================="

# Create virtual environment
python3 -m venv venv
source venv/bin/activate

# Install dependencies
pip install --upgrade pip
pip install -r requirements.txt

# Setup environment
cp .env.example .env
echo "âš ï¸  Please configure your .env file with production settings"

# Create directories
mkdir -p logs media/documents staticfiles backups

# Run migrations
python manage.py migrate

# Collect static files
python manage.py collectstatic --noinput

# Create superuser (optional)
echo "from django.contrib.auth.models import User; User.objects.create_superuser('admin', 'admin@example.com', 'changeme') if not User.objects.filter(username='admin').exists() else None" | python manage.py shell

echo "âœ… Deployment completed!"
echo "ğŸš€ Start with: python manage.py runserver"
EOF
        chmod +x dist/ai-report-writer/deploy.sh

        # Create archive
        cd dist
        tar -czf ai-report-writer-${{ github.sha }}.tar.gz ai-report-writer/
        cd ..

        echo "âœ… Distribution package created"

    - name: ğŸ“¤ Upload Build Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ai-report-writer-build
        path: |
          dist/ai-report-writer-${{ github.sha }}.tar.gz
        retention-days: 90

    - name: ğŸ“Š Build Summary
      run: |
        echo "## ğŸ“¦ Build Results" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Static Files | âœ… Collected |" >> $GITHUB_STEP_SUMMARY
        echo "| Package | âœ… Created |" >> $GITHUB_STEP_SUMMARY
        echo "| Archive | âœ… ai-report-writer-${{ github.sha }}.tar.gz |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ğŸš€ DEPLOYMENT
  # ============================================================================
  deploy:
    name: ğŸš€ Deploy to ${{ needs.pre-flight.outputs.environment }}
    runs-on: ubuntu-latest
    needs: [pre-flight, build-package]
    if: needs.pre-flight.outputs.should-deploy == 'true'
    environment: ${{ needs.pre-flight.outputs.environment }}

    steps:
    - name: ğŸ“¥ Download Build Artifacts
      uses: actions/download-artifact@v3
      with:
        name: ai-report-writer-build
        path: ./artifacts

    - name: ğŸš€ Deploy to ${{ needs.pre-flight.outputs.environment }}
      run: |
        echo "ğŸš€ Deploying AI Report Writer to ${{ needs.pre-flight.outputs.environment }}"
        echo "ğŸ“¦ Package: ai-report-writer-${{ github.sha }}.tar.gz"
        echo "ğŸŒ Environment: ${{ needs.pre-flight.outputs.environment }}"

        # This is where you would add your actual deployment steps
        # Examples:
        # - Upload to server via SSH/SCP
        # - Deploy to cloud platform (AWS, Azure, GCP)
        # - Update container registry
        # - Trigger deployment webhook

        echo "âœ… Deployment completed successfully!"

    - name: ğŸ“Š Deployment Summary
      run: |
        echo "## ğŸš€ Deployment Results" >> $GITHUB_STEP_SUMMARY
        echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Environment | ${{ needs.pre-flight.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Package | ai-report-writer-${{ github.sha }}.tar.gz |" >> $GITHUB_STEP_SUMMARY
        echo "| Status | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ğŸ‰ PIPELINE SUMMARY
  # ============================================================================
  pipeline-summary:
    name: ğŸ‰ Pipeline Summary
    runs-on: ubuntu-latest
    needs: [pre-flight, setup-python, database-setup, test-suite, code-quality, security-scan, build-package, deploy]
    if: always()

    steps:
    - name: ğŸ“Š Generate Pipeline Summary
      run: |
        echo "# ğŸ¤– AI Report Writer Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“‹ Pipeline Overview" >> $GITHUB_STEP_SUMMARY
        echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ” Pre-flight | ${{ needs.pre-flight.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.pre-flight.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ Python Setup | ${{ needs.setup-python.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.setup-python.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ—„ï¸ Database | ${{ needs.database-setup.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.database-setup.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ§ª Tests | ${{ needs.test-suite.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.test-suite.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ¨ Code Quality | ${{ needs.code-quality.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ”’ Security | ${{ needs.security-scan.result == 'success' && 'âœ…' || needs.security-scan.result == 'skipped' && 'â­ï¸' || 'âŒ' }} ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ“¦ Build | ${{ needs.build-package.result == 'success' && 'âœ…' || needs.build-package.result == 'skipped' && 'â­ï¸' || 'âŒ' }} ${{ needs.build-package.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸš€ Deploy | ${{ needs.deploy.result == 'success' && 'âœ…' || needs.deploy.result == 'skipped' && 'â­ï¸' || 'âŒ' }} ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Determine overall status
        if [[ "${{ needs.pre-flight.result }}" == "success" && "${{ needs.setup-python.result }}" == "success" && "${{ needs.database-setup.result }}" == "success" && "${{ needs.test-suite.result }}" == "success" && "${{ needs.code-quality.result }}" == "success" ]]; then
          echo "## ğŸ‰ Pipeline Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
          echo "All critical stages completed successfully!" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âŒ Pipeline Status: FAILED" >> $GITHUB_STEP_SUMMARY
          echo "One or more critical stages failed. Please check the logs." >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ”— Useful Links" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“Š [Test Results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ”’ [Security Reports](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“¦ [Build Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“š [Documentation](https://github.com/${{ github.repository }}/tree/${{ github.ref_name }}/docs)" >> $GITHUB_STEP_SUMMARY

    - name: ğŸ”” Notification Summary
      run: |
        echo "ğŸ”” Pipeline completed for AI Report Writer"
        echo "ğŸ“Š Branch: ${{ github.ref_name }}"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        echo "ğŸ¯ Event: ${{ github.event_name }}"

        # This is where you could add notifications to Slack, Discord, email, etc.
